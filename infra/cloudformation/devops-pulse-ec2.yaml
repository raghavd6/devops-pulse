---
AWSTemplateFormatVersion: '2010-09-09'
Description: >
  DevOps Pulse â€“ EC2 deployment with Docker Compose via UserData.
  Provisions VPC, subnet, security group, and EC2 instance. UserData installs Docker,
  clones your repo, and runs docker compose.

Parameters:
  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: >
      Name of an existing EC2 KeyPair to enable SSH access.
  InstanceType:
    Type: String
    Default: t3.micro
    AllowedValues:
      - t3.micro
      - t3.small
      - t3.medium
    Description: EC2 instance type.
  VpcCidr:
    Type: String
    Default: 10.0.0.0/16
  PublicSubnetCidr:
    Type: String
    Default: 10.0.1.0/24
  RepoUrl:
    Type: String
    Default: https://github.com/your-org/your-devops-pulse-repo
    Description: >
      Git repository URL containing docker-compose.yml at project root.
  Branch:
    Type: String
    Default: main
    Description: Branch to clone.
  ComposePath:
    Type: String
    Default: docker-compose.yml
    Description: >
      Relative path to docker-compose file inside the repo.
  AppHttpPort:
    Type: Number
    Default: 80
    Description: Port exposed by frontend service.

Mappings:
  RegionMap:
    eu-west-2:
      AMI: ami-0d0b1e0f0e9ae1e95  # Amazon Linux 2 (example; override if needed)
    eu-west-1:
      AMI: ami-0900a5c62e0d6363b
    us-east-1:
      AMI: ami-0c02fb55956c7d316

Resources:
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: DevOpsPulseVPC

  InternetGateway:
    Type: AWS::EC2::InternetGateway

  VPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  PublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PublicSubnetCidr
      MapPublicIpOnLaunch: true
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: DevOpsPulsePublicSubnet

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC

  PublicRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  SubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet

  SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow HTTP/HTTPS/SSH to EC2
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: !Ref AppHttpPort
          ToPort: !Ref AppHttpPort
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0

  InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles: []
    Metadata:
      Comment: >
        In Learner Lab, IAM creation may be limited; using empty profile to avoid CAPABILITY_IAM.

  EC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !FindInMap [RegionMap, !Ref 'AWS::Region', AMI]
      InstanceType: !Ref InstanceType
      KeyName: !Ref KeyName
      SubnetId: !Ref PublicSubnet
      SecurityGroupIds:
        - !Ref SecurityGroup
      UserData: !Base64 |
        #!/bin/bash
        set -euxo pipefail
        yum update -y
        amazon-linux-extras install docker -y || yum install -y docker
        systemctl enable docker
        systemctl start docker
        curl -fsSL https://get.docker.com | sh || true
        usermod -aG docker ec2-user
        yum install -y git
        mkdir -p /opt/app && chown ec2-user:ec2-user /opt/app
        cd /opt/app
        sudo -u ec2-user git clone --branch ${Branch} ${RepoUrl} repo
        cd repo
        # Try Docker Compose v2 plugin, fallback to python-based compose
        if docker compose version; then
          docker compose -f ${ComposePath} up -d
        else
          curl -L \
            "https://github.com/docker/compose/releases/download/v2.6.1/docker-compose-$(uname -s)-$(uname -m)" \
            -o /usr/local/bin/docker-compose
          chmod +x /usr/local/bin/docker-compose
          docker-compose -f ${ComposePath} up -d
        fi
    Metadata:
      Comment: >
        UserData clones repo and starts services via docker compose.

Outputs:
  InstancePublicIp:
    Description: Public IP of the EC2 instance.
    Value: !GetAtt EC2Instance.PublicIp
  HttpUrl:
    Description: HTTP URL to access frontend.
    Value: !Sub >
      http://${EC2Instance.PublicIp}:${AppHttpPort}
