name: ci-cd
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  build_test:
    name: Build & Test (Node)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Run BACKEND tests only if backend/package.json exists
      - name: Backend install
        if: ${{ hashFiles('backend/package.json') != '' }}
        working-directory: backend
        run: npm ci
      - name: Backend tests
        if: ${{ hashFiles('backend/package.json') != '' }}
        working-directory: backend
        run: npm test

      # Run FRONTEND tests only if frontend/package.json exists
      - name: Frontend install
        if: ${{ hashFiles('frontend/package.json') != '' }}
        working-directory: frontend
        run: npm ci
      - name: Frontend tests
        if: ${{ hashFiles('frontend/package.json') != '' }}
        working-directory: ./frontend
        run: npx vitest run
        
      # Optional: if your folders are named differently (api/web),
      # keep these two blocks and delete the ones above, or add similarly:
      - name: API install
        if: ${{ hashFiles('api/package.json') != '' }}
        working-directory: api
        run: npm ci
      - name: API tests
        if: ${{ hashFiles('api/package.json') != '' }}
        working-directory: api
        run: npm test

      - name: Web install
        if: ${{ hashFiles('web/package.json') != '' }}
        working-directory: web
        run: npm ci
      - name: Web tests
        if: ${{ hashFiles('web/package.json') != '' }}
        working-directory: web
        run: npm run test

  validate_iac:
    name: Validate CloudFormation (YAML + CFN lint)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Python tools
        run: |
          python3 -m pip install --upgrade pip
          pip install yamllint cfn-lint

      - name: .yamllint config (optional)
        run: |
          cat > .yamllint.yml <<'EOF'
          extends: default
          rules:
            line-length:
              max: 160
              level: warning
            document-start: enable
            trailing-spaces: enable
            indentation:
              indent-sequences: consistent
          EOF

      - name: Validate YAML
        run: yamllint -c .yamllint.yml infra/cloudformation/devops-pulse-ec2.yaml

      - name: Validate CloudFormation
        run: cfn-lint infra/cloudformation/devops-pulse-ec2.yaml

      # Optional: show the would-be deploy command (good for your video narrative)
      - name: Render deploy command (dry-run narrative)
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          echo "aws cloudformation deploy --stack-name devops-pulse --region eu-west-2 \\"
          echo "  --template-file infra/cloudformation/devops-pulse-ec2.yaml \\"
          echo "  --parameter-overrides $(jq -r '.ParameterOverrides | to_entries | map(\"\\(.key)=\\(.value)\") | join(\" \")' infra/cloudformation/parameters.json) \\"
          echo "  --capabilities CAPABILITY_NAMED_IAM"
