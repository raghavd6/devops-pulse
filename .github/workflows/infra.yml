name: infra

on:
  pull_request:
    paths:
      - 'infra/**'
      - '.github/workflows/infra.yml'
  push:
    branches: [ main ]
    paths:
      - 'infra/**'
      - '.github/workflows/infra.yml'

permissions:
  contents: read

jobs:
  # COMMENTED OUT: Azure Bicep validation and deployment
  # validate_whatif:
  #   name: Validate + What-If (Bicep)
  #   runs-on: ubuntu-latest
  #
  #   steps:
  #     - uses: actions/checkout@v4
  #
  #     - name: Azure login (OIDC)
  #       uses: azure/login@v2
  #       with:
  #         client-id: ${{ secrets.AZURE_CLIENT_ID }}
  #         tenant-id: ${{ secrets.AZURE_TENANT_ID }}
  #         subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  #
  #     - name: Validate
  #       uses: azure/bicep-deploy@v2
  #       with:
  #         type: deployment
  #         operation: validate
  #         scope: resourceGroup
  #         subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  #         resource-group-name: ${{ vars.AZURE_RESOURCE_GROUP }}
  #         template-file: infra/main.bicep
  #         parameters-file: infra/parameters.dev.json
  #
  #     - name: What-If
  #       uses: azure/bicep-deploy@v2
  #       with:
  #         type: deployment
  #         operation: whatIf
  #         scope: resourceGroup
  #         subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  #         resource-group-name: ${{ vars.AZURE_RESOURCE_GROUP }}
  #         template-file: infra/main.bicep
  #         parameters-file: infra/parameters.dev.json
  #
  # deploy:
  #   name: Deploy infra (Bicep)
  #   runs-on: ubuntu-latest
  #   needs: validate_whatif
  #   if: github.event_name == 'push' && github.ref == 'refs/heads/main'
  #
  #   steps:
  #     - uses: actions/checkout@v4
  #
  #     - name: Azure login (OIDC)
  #       uses: azure/login@v2
  #       with:
  #         client-id: ${{ secrets.AZURE_CLIENT_ID }}
  #         tenant-id: ${{ secrets.AZURE_TENANT_ID }}
  #         subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  #
  #     - name: Deploy
  #       uses: azure/bicep-deploy@v2
  #       with:
  #         type: deployment
  #         operation: create
  #         scope: resourceGroup
  #         subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  #         resource-group-name: ${{ vars.AZURE_RESOURCE_GROUP }}
  #         template-file: infra/main.bicep
  #         parameters-file: infra/parameters.dev.json
